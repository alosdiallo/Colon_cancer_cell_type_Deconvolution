---
title: "HITIMED_Analysis"
author: "Alos Diallo"
date: "2024-04-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r message=FALSE, warning=FALSE}
library(minfi)
library(sesame)
library(pheatmap)
library(minfiData)
library(IlluminaHumanMethylationEPICmanifest)
library(FlowSorted.Blood.EPIC)
library(HiTIMED)
library(ggplot2)
library(dplyr)
library(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
library(IlluminaHumanMethylationEPICv2manifest)
library(IlluminaHumanMethylationEPICv2anno.20a1.hg38)
library(limma)
```

Loading the datasets
```{r}
covar.data <- read.csv("F:/GS/PhD/Christensen_Lab/Colon_Project/dnm_data/Colon_DH_manifest.csv")
covar.data$patient <- paste(covar.data$Sentrix_ID,covar.data$Sentrix_Position,sep="_")
rownames(covar.data) <- covar.data$patient
```


Loading the data
```{r}
RGset_eV1 = read.metharray.exp("F:/GS/PhD/Christensen_Lab/Colon_Project/dnm_data/",recursive = TRUE) 
MSet <-preprocessNoob(RGset_eV1)
Betas<-getBeta(MSet)
Betas<- sesame::betasCollapseToPfx(Betas)
load("25_files_data_converted.RData")
#HiTIMED_result<-HiTIMED_deconvolution(Betas,"COAD",6,"tumor")
```

putting the two datasets together
```{r}
merged_Betas <- merge(Betas, v2_Betas, by = "row.names")
rownames(merged_Betas) <- merged_Betas$Row.names
merged_Betas <- merged_Betas[,-1] 
#save(merged_Betas, file = "all_samples.RData")

```

Get TCGA data

```{r}
tcga.data <- readRDS("TCGA_data.rds")
tcga.dnam <- tcga.data[["dnam"]]
tcga.pheno <- tcga.data[["pheno"]]
tcga.cell <- tcga.data[["cell_types"]]
msi_dat<-readRDS("msi_tcga.rds")
tcga.cell$COAD_Deconv1#$MSS
tcga.cell$COAD_Deconv2#MASS

tcga_T = t(tcga.dnam)
```


HiTIMED
Run HiTIMED
```{r}
HiTIMED_result_1<-HiTIMED_deconvolution(merged_Betas,"COAD",1,"tumor")
HiTIMED_result_2<-HiTIMED_deconvolution(merged_Betas,"COAD",2,"tumor")
HiTIMED_result_3<-HiTIMED_deconvolution(merged_Betas,"COAD",3,"tumor")
HiTIMED_result_4<-HiTIMED_deconvolution(merged_Betas,"COAD",4,"tumor")
HiTIMED_result_5<-HiTIMED_deconvolution(merged_Betas,"COAD",5,"tumor")
HiTIMED_result_6<-HiTIMED_deconvolution(merged_Betas,"COAD",6,"tumor")


tcga_result_1<-HiTIMED_deconvolution(tcga_T,"COAD",1,"tumor")
tcga_result_2<-HiTIMED_deconvolution(tcga_T,"COAD",2,"tumor")
tcga_result_3<-HiTIMED_deconvolution(tcga_T,"COAD",3,"tumor")
tcga_result_4<-HiTIMED_deconvolution(tcga_T,"COAD",4,"tumor")
tcga_result_5<-HiTIMED_deconvolution(tcga_T,"COAD",5,"tumor")
tcga_result_6<-HiTIMED_deconvolution(tcga_T,"COAD",6,"tumor")
```
```{r}
library(tidyverse)

# Add source to each dataset to distinguish between DH and TCGA
HiTIMED_result_1$Source <- "DH"
HiTIMED_result_2$Source <- "DH"
HiTIMED_result_3$Source <- "DH"
HiTIMED_result_4$Source <- "DH"
HiTIMED_result_5$Source <- "DH"
HiTIMED_result_6$Source <- "DH"

tcga_result_1$Source <- "TCGA"
tcga_result_2$Source <- "TCGA"
tcga_result_3$Source <- "TCGA"
tcga_result_4$Source <- "TCGA"
tcga_result_5$Source <- "TCGA"
tcga_result_6$Source <- "TCGA"

# Combine DH and TCGA data frames for each level
data_level_1 <- bind_rows(HiTIMED_result_1, tcga_result_1)
data_level_2 <- bind_rows(HiTIMED_result_2, tcga_result_2)
data_level_3 <- bind_rows(HiTIMED_result_3, tcga_result_3)
data_level_4 <- bind_rows(HiTIMED_result_4, tcga_result_4)
data_level_5 <- bind_rows(HiTIMED_result_5, tcga_result_5)
data_level_6 <- bind_rows(HiTIMED_result_6, tcga_result_6)

# Set a unique ID for each level and source combination
data_level_1$ID <- "Level_1"
data_level_2$ID <- "Level_2"
data_level_3$ID <- "Level_3"
data_level_4$ID <- "Level_4"
data_level_5$ID <- "Level_5"
data_level_6$ID <- "Level_6"

# Combine all data frames into one
combined_data <- bind_rows(data_level_1, data_level_2, data_level_3,
                           data_level_4, data_level_5, data_level_6)

# Reshape data to long format
long_data <- combined_data %>%
  pivot_longer(
    -c(SampleID, ID, Source),  # Exclude the SampleID, ID, and Source columns from the reshaping process
    names_to = "CellType",
    values_to = "Proportion"
  )

# Generate boxplot using ggplot2
ggplot(long_data, aes(x = CellType, y = Proportion, fill = Source)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Distribution of Cell Types across DH and TCGA Results", x = "Cell Type", y = "Proportion") +
  facet_wrap(~ID, scales = "free_x", ncol = 1) +  # Use one column of facets for clarity
  scale_fill_brewer(palette = "Set1")  # Use a clear color palette for distinction

# Save the plot
ggsave("Combined_HiTIMED_TCGA_boxplots.png", width = 20, height = 30)

```

```{r}
# Combine DH and TCGA data frames for each level
levels_data <- list(
  data_level_1 = bind_rows(HiTIMED_result_1, tcga_result_1),
  data_level_2 = bind_rows(HiTIMED_result_2, tcga_result_2),
  data_level_3 = bind_rows(HiTIMED_result_3, tcga_result_3),
  data_level_4 = bind_rows(HiTIMED_result_4, tcga_result_4),
  data_level_5 = bind_rows(HiTIMED_result_5, tcga_result_5),
  data_level_6 = bind_rows(HiTIMED_result_6, tcga_result_6)
)

# Iterate over each level to create and save plots
for (level in names(levels_data)) {
  # Set ID for each dataset
  levels_data[[level]]$ID <- level
  
  # Reshape data to long format
  long_data <- pivot_longer(
    levels_data[[level]],
    -c(SampleID, ID, Source),  # Exclude these columns from reshaping
    names_to = "CellType",
    values_to = "Proportion"
  )
  
  # Generate boxplot using ggplot2
  plot <- ggplot(long_data, aes(x = CellType, y = Proportion, fill = Source)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    labs(title = paste("Distribution of Cell Types at", level, "across DH and TCGA Results"), 
         x = "Cell Type", y = "Proportion") +
    scale_fill_brewer(palette = "Set1")  # Clear color distinction
  
  # Save each plot with a unique filename
  plot_file_name <- paste0("Plot_", level, ".png")
  ggsave(plot_file_name, plot, width = 12, height = 8)
}
```



