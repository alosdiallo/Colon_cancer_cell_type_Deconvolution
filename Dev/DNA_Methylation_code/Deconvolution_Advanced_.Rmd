---
title: "R Notebook"
output: html_notebook
---

```{r warning=FALSE}
# ─────────────────────────────────────────────────────────────────────
#
#  Cell-type proportion pipeline  (HiTIMED + EpiSCORE, COAD example)
#
#  Cohorts
#    • Dartmouth EPIC v1 / EPIC v2
#    • TCGA COAD (HM-450K)
#    • GTEx colon normals (EPIC v1)
#
#  Outputs  →  plots/, statistics/, HiTIMED_level6_norm.csv, EpiSCORE_proportions.csv
# --------------------------------------------------------------------
# >>>>>  EDIT ONLY THE FIVE PATHS BELOW  <<<<<
# --------------------------------------------------------------------
PATH_DH_32 <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/DNA_Methylation/dm_data/no_match/idats/"
PATH_DH_25 <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/DNA_Methylation/dm_data/no_match/25_samples/"
META_DH    <- "/Users/adiallo/Desktop/Thesis/Data_Documents/data_all.csv"
FILE_TCGA  <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/DNA_Methylation/dm_data/TCGA/TCGA_data.rds"
FILE_MSI   <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/DNA_Methylation/dm_data/TCGA/msi_tcga.rds"
FILE_GTEX  <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/DNA_Methylation/dm_data/GTEx/GTEx_samples.rds"
# ────────────────────────────────────────────────────────────────────

suppressPackageStartupMessages({
  library(minfi);  library(ENmix);   library(sesame)
  library(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
  library(sva);    library(HiTIMED); library(EpiDISH)
  library(dplyr);  library(tidyr);   library(ggplot2); library(ggpubr)
  library(purrr);  library(tibble);  library(fs);      library(broom)
})

# ── folder scaffold ────────────────────────────────────────────────
dir_create(c("plots/tumour_vs_normal",
             "plots/metastasis_flags",
             "plots/msi",
             "plots/disease_state",
             "plots/disease_state_MSI",
             "plots/disease_state_plus_normal",
             "statistics"))

# ── helpers ────────────────────────────────────────────────────────
anno      <- getAnnotation(IlluminaHumanMethylationEPICanno.ilm10b4.hg19)
sex_cpgs  <- rownames(anno)[anno$chr %in% c("chrX","chrY")]
rm_sex    <- \(b) b[!(rownames(b) %in% sex_cpgs), ]
orient    <- \(m) if (grepl("^cg", rownames(m)[1])) m else t(m)

run_noob_qc <- function(path){
  rg  <- read.metharray.exp(path, recursive = TRUE)
  bet <- getBeta(preprocessNoob(rg))
  rgx <- read.metharray.exp(path, recursive = TRUE, extended = TRUE)
  bad <- ENmix::QCinfo(rgx)$badCpG
  rm_sex(bet[!(rownames(bet) %in% bad), ])
}

run_episcore <- function(beta){
  common <- intersect(rownames(beta), rownames(centEpiFibIC.m))
  est    <- epidish(beta[common, ], centEpiFibIC.m[common, ], "RPC")$estF
  as.data.frame(est) * 100
}

wilcox_flag <- function(df, flag, cols){
  map_dfr(cols, \(cn){
    sub <- filter(df, !is.na(.data[[flag]]))
    if(n_distinct(sub[[flag]]) != 2)
      return(tibble(Cell=cn,Flag=flag,P=NA,n0=NA,n1=NA))
    w <- wilcox.test(sub[[cn]] ~ sub[[flag]])
    tibble(Cell=cn,Flag=flag,P=w$p.value,
           n0=sum(sub[[flag]]==levels(factor(sub[[flag]]))[1]),
           n1=sum(sub[[flag]]==levels(factor(sub[[flag]]))[2]))
  })
}

## 2-level plot
plot_box <- function(df, y, x, file,
                     palette=c("#E64B35FF","#4DBBD5FF")){
  df <- filter(df, !is.na(.data[[x]]))
  if(n_distinct(df[[x]])<2) return()
  df[[x]] <- factor(df[[x]])
  y_clip  <- pmax(df[[y]],0)

  p <- ggplot(df,aes(.data[[x]],y_clip,fill=.data[[x]]))+
         geom_boxplot(outlier.shape=NA,alpha=.5)+
         geom_jitter(width=.2,size=1)+
         stat_compare_means(method="wilcox.test")+
         scale_fill_manual(values=palette,guide="none")+
         theme_bw(11)+
         labs(title=paste(y,"vs",x),x=NULL,y=y)
  ggsave(file,p,width=4,height=4,dpi=300)
}

## ≥3-level plot with global + pairwise tests
plot_box_multi <- function(df, y,
                           x="disease_state",
                           palette=c("#8DA0CB","#E78AC3","#FFFF99"),
                           file,
                           title=NULL){
  df <- filter(df,!is.na(.data[[x]]))
  if(n_distinct(df[[x]])<2) return()
  df[[x]] <- factor(df[[x]])

  y_clip <- pmax(df[[y]],0)
  ymax   <- max(y_clip,na.rm=TRUE)
  comps  <- combn(levels(df[[x]]),2,simplify=FALSE)

  ggplot(df,aes(.data[[x]],y_clip,fill=.data[[x]]))+
    geom_boxplot(outlier.shape=NA,alpha=.6,width=.65)+
    geom_jitter(width=.15,size=1)+
    scale_fill_manual(values=palette,guide="none")+
    stat_compare_means(method="kruskal.test",
                       label.y=ymax*1.12,label.x=1,size=3.5)+
    stat_compare_means(comparisons=comps,method="wilcox.test",
                       label="p.signif",hide.ns=TRUE,
                       label.y=seq(ymax*1.05,ymax*0.85,length.out=length(comps)))+
    theme_bw(11)+
    labs(title=title %||% paste(y,"across groups"),x=NULL,y=y)

  ggsave(file,width=4,height=4,dpi=300)
}
plot_box_groups <- plot_box_multi   # ← alias for clarity

# ── 1. Dartmouth EPIC ───────────────────────────────────────────────
beta_32 <- run_noob_qc(PATH_DH_32)
beta_25 <- run_noob_qc(PATH_DH_25)
beta_32 <- betasCollapseToPfx(beta_32); beta_25 <- betasCollapseToPfx(beta_25)

common_DH <- intersect(rownames(beta_32),rownames(beta_25))
beta_DH   <- cbind(beta_32[common_DH,],beta_25[common_DH,])
platform_DH <- rep(c("EPIC_v2","EPIC_v1"),
                   c(ncol(beta_32),ncol(beta_25)))

# ── 2. TCGA ─────────────────────────────────────────────────────────
TCGA         <- readRDS(FILE_TCGA)
beta_TCGA    <- orient(rm_sex(TCGA$dnam))
platform_TCGA<- rep("HM450",ncol(beta_TCGA))

ph <- TCGA$pheno %>% mutate(
        Distant_Mets = ifelse(ajcc_pathologic_m=="M0",0,
                         ifelse(grepl("^M1",ajcc_pathologic_m),1,NA)),
        LN_pos       = ifelse(ajcc_pathologic_n=="N0",0,
                         ifelse(grepl("^N",ajcc_pathologic_n),1,NA)),
        ln_only      = ifelse(LN_pos==1 & Distant_Mets==0,1,
                         ifelse(LN_pos==0 & Distant_Mets==0,0,NA)),
        any_mets     = ifelse(LN_pos==1 | Distant_Mets==1,1,
                         ifelse(LN_pos==0 & Distant_Mets==0,0,NA)),
        SampleID     = substr(bcr_patient_barcode,1,12)) %>%
      select(SampleID,any_mets,ln_only,Distant_Mets)

# ── 3. TCGA MSI ─────────────────────────────────────────────────────
msi_raw  <- readRDS(FILE_MSI)
bc_col   <- intersect(c("bcr_patient_barcode","case_submitter_id",
                        "sample_id","SampleID"),colnames(msi_raw))[1]
status_col <- "mononucleotide_and_dinucleotide_marker_panel_analysis_status"

msi_tbl <- msi_raw %>% transmute(
              SampleID = substr(.data[[bc_col]],1,12),
              MSI_bin  = case_when(
                           .data[[status_col]] %in% c("MSI-H","MSI-L") ~ 1,
                           .data[[status_col]] == "MSS"                ~ 0,
                           TRUE                                         ~ NA_real_))

# ── 4. GTEx normals ────────────────────────────────────────────────
beta_GTEx     <- orient(rm_sex(readRDS(FILE_GTEX)))
platform_GTEx <- rep("GTEx",ncol(beta_GTEx))

# ── 5. two-stage ComBat ─────────────────────────────────────────────
common12 <- intersect(rownames(beta_DH),rownames(beta_TCGA))
beta_dis <- cbind(beta_DH[common12,],beta_TCGA[common12,])
beta_dis <- beta_dis[rowSums(is.na(beta_dis))==0,]
beta_bc_dis <- ComBat(beta_dis,batch=factor(c(platform_DH,platform_TCGA)),
                      par.prior=TRUE,prior.plots=FALSE)

commonAll <- intersect(rownames(beta_bc_dis),rownames(beta_GTEx))
beta_all  <- cbind(beta_bc_dis[commonAll,],beta_GTEx[commonAll,])
batch_all <- factor(c(rep("Disease",ncol(beta_bc_dis)),
                      rep("GTEx",ncol(beta_GTEx))),
                    levels=c("Disease","GTEx"))
beta_bc   <- ComBat(beta_all,batch=batch_all,ref.batch="Disease",
                    par.prior=TRUE,prior.plots=FALSE)

# ── 6. HiTIMED ─────────────────────────────────────────────────────
h2 <- as.data.frame(HiTIMED_deconvolution(beta_bc,"COAD",2))
h6 <- as.data.frame(HiTIMED_deconvolution(beta_bc,"COAD",6))
h6$SampleID <- rownames(h6)
h6$Platform <- factor(c(platform_DH,platform_TCGA,platform_GTEx))

subpops <- c("Bas","Eos","Neu","Mono","DC","Bnv","Bmem",
             "CD4nv","CD4mem","Treg","CD8nv","CD8mem","NK")

h6_norm <- h6 %>% mutate(
              across(all_of(subpops),~ .x / h2$Immune,
                     .names="{.col}_norm"),
              across(matches("_norm$"),~pmax(.x,0)))  # clip <0

# ── 7. EpiSCORE ────────────────────────────────────────────────────
epi <- run_episcore(beta_bc)

# ── 8. merge meta ──────────────────────────────────────────────────
meta_DH <- read.csv(META_DH) %>% mutate(
              SampleID = paste(Sentrix_ID,Sentrix_Position,sep="_"),
              MSI_bin  = ifelse(MLH1==0,1,ifelse(MLH1==1,0,NA))) %>%
            select(SampleID,any_mets,ln_only,Distant_Mets,MSI_bin)

h6_all <- h6_norm %>% mutate(
            dataset = case_when(
                        grepl("^20",SampleID)   ~ "GTEx",
                        grepl("^TCGA",SampleID) ~ "TCGA",
                        TRUE                    ~ "DH"),
            Immune  = h2$Immune[match(SampleID,rownames(h2))]) %>%
          left_join(bind_rows(meta_DH,ph),by="SampleID") %>%
          left_join(msi_tbl,by="SampleID",suffix=c("",".msi")) %>%
          mutate(MSI_bin = coalesce(MSI_bin,MSI_bin.msi)) %>%
          select(-MSI_bin.msi)

norm_cols <- paste0(subpops,"_norm")
flags     <- c("any_mets","ln_only","Distant_Mets")

# ── 9 A. tumour-only Wilcoxon ──────────────────────────────────────
disease_df <- filter(h6_all,dataset %in% c("DH","TCGA"))

write.csv(map_dfr(flags, \(fl) wilcox_flag(disease_df,fl,norm_cols)),
          "statistics/wilcox_disease_only_rawP.csv",row.names=FALSE)
write.csv(wilcox_flag(disease_df,"MSI_bin",norm_cols),
          "statistics/wilcox_MSI_strata_rawP.csv",row.names=FALSE)

write.csv(map_dfr(flags, \(fl)
            wilcox_flag(filter(disease_df,MSI_bin==0),fl,norm_cols)) %>%
          mutate(MSI="stable"),
          "statistics/wilcox_MSI0_rawP.csv",row.names=FALSE)
write.csv(map_dfr(flags, \(fl)
            wilcox_flag(filter(disease_df,MSI_bin==1),fl,norm_cols)) %>%
          mutate(MSI="unstable"),
          "statistics/wilcox_MSI1_rawP.csv",row.names=FALSE)

# ── 9 B. tumour vs normal ──────────────────────────────────────────
tvn_df  <- mutate(h6_all,Group=ifelse(dataset=="GTEx","Normal","Tumour"))
write.csv(wilcox_flag(tvn_df,"Group",norm_cols),
          "statistics/wilcox_tumour_vs_normal_rawP.csv",row.names=FALSE)

# ── 9 C. 3- & 4-level disease factors ─────────────────────────────
disease_df <- mutate(disease_df,
                     disease_state=factor(case_when(
                       Distant_Mets==1 ~ "Distant_Mets",
                       ln_only==1      ~ "LN_Mets",
                       TRUE            ~ "No_Mets"),
                       levels=c("No_Mets","LN_Mets","Distant_Mets")))

disease_plus_norm <- h6_all %>%
  mutate(disease_state4=factor(case_when(
           dataset=="GTEx" ~ "Normal",
           Distant_Mets==1 ~ "Distant_Mets",
           ln_only==1      ~ "LN_Mets",
           TRUE            ~ "No_Mets"),
         levels=c("Normal","No_Mets","LN_Mets","Distant_Mets"))) %>%
  select(SampleID,disease_state4,Immune,all_of(norm_cols))

# ── 10. plots ───────────────────────────────────────────────────────
walk(norm_cols,
     ~plot_box(tvn_df,.x,"Group",
               file=file.path("plots/tumour_vs_normal",
                              paste0(.x,"_Tumour_vs_Normal.png"))))

walk(flags, \(fl)
  walk(norm_cols, \(cell)
    plot_box(disease_df,cell,fl,
             file=file.path("plots/metastasis_flags",
                            paste0(cell,"_",fl,".png")))))

walk(norm_cols,
     ~plot_box(disease_df,.x,"MSI_bin",
               file=file.path("plots/msi",paste0(.x,"_MSI_bin.png"))))

walk(c("Immune",norm_cols),
     ~plot_box_groups(disease_df,.x,
                      palette=c("#8DA0CB","#E78AC3","#FFFF99"),
                      file=file.path("plots/disease_state",
                                     paste0(.x,"_3level.png"))))

walk(c(0,1), \(m){
  lab <- ifelse(m==0,"MSS","MSI")
  sub <- filter(disease_df,MSI_bin==m)
  walk(c("Immune",norm_cols),
       \(cell) plot_box_groups(sub,cell,
                               palette=c("#8DA0CB","#E78AC3","#FFFF99"),
                               title=paste(cell,"|",lab),
                               file=file.path("plots/disease_state_MSI",
                                              paste0(cell,"_3level_",lab,".png"))))
})

four_pal <- c("#66C2A5","#FC8D62","#8DA0CB","#E78AC3")
walk(c("Immune",norm_cols),
     \(cell) plot_box_groups(disease_plus_norm,cell,x="disease_state4",
                             palette=four_pal,
                             title=paste(cell,"Normal vs Disease"),
                             file=file.path("plots/disease_state_plus_normal",
                                            paste0(cell,"_4level_plusNormal.png"))))

# ── 11. export proportion tables ───────────────────────────────────
write.csv(h6_norm,"HiTIMED_level6_norm.csv",row.names=FALSE)

epi_out <- epi %>% t() %>% as.data.frame() %>% rownames_to_column("SampleID")
epi_out$Platform <- h6$Platform[match(epi_out$SampleID,h6$SampleID)]
write.csv(epi_out,"EpiSCORE_proportions.csv",row.names=FALSE)

message("✅  Statistics in 'statistics/', plots in sub-folders of 'plots/'")
```

