---
title: "Cottrazm_worker"
author: "Alos Diallo"
date: "2024-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

# Copy and modify the STPreProcess function
STPreProcess_mod <- function(InDir = InDir, Sample = Sample, OutDir = NULL) {
  if (is.null(OutDir) == TRUE) {
    OutDir <- paste(getwd(), "/", Sample, "/", sep = "")
    dir.create(OutDir)
  }

  # read files------
  aa_try <- try(
    Xdata <- Seurat::Read10X(data.dir = paste(InDir, "filtered_feature_bc_matrix", sep = "")),
    silent = T
  )
  if (is(aa_try, "try-error")) {
    Xdata <- Seurat::Read10X_h5(filename = paste(InDir, "filtered_feature_bc_matrix.h5", sep = ""))
  } else {
    Xdata <- Xdata
  }

  # Modify the line below by removing 'min.spots = 0'
  XF <- CreateSeuratObject(counts = Xdata, project = Sample, assay = "Spatial")

  # ... rest of the function remains the same
  # read image files
  Ximage <- Read10X_Image(image.dir = paste(InDir, "spatial", sep = ""))
  Seurat::DefaultAssay(Ximage) <- "Spatial"
  Ximage <- Ximage[colnames(XF)]
  XF[["image"]] <- Ximage
  TumorST <- XF

  # QC----
  dir.create(paste(OutDir, "QC", sep = ""))
  TumorST[["Mito.percent"]] <- PercentageFeatureSet(TumorST, pattern = "^MT-")

  pdf(paste(OutDir, "QC/Vlnplot.pdf", sep = ""), width = 6, height = 4)
  p <- VlnPlot(TumorST, features = c("nFeature_Spatial", "nCount_Spatial", "Mito.percent"), pt.size = 0, combine = F)
  for (i in 1:length(p)) {
    p[[i]] <- p[[i]] + NoLegend() + theme(axis.title.x = element_blank(), axis.text.x = element_text(angle = 0))
  }
  p <- cowplot::plot_grid(plotlist = p, ncol = 3)
  print(p)
  dev.off()

  pdf(paste(OutDir, "QC/featurplot.pdf", sep = ""), width = 7, height = 7)
  p <- SpatialFeaturePlot(TumorST, features = c("nFeature_Spatial", "nCount_Spatial", "Mito.percent"), combine = F)
  for (i in 1:length(p)) {
    p[[i]] <- p[[i]] + theme(axis.title.x = element_blank(), axis.text.x = element_text(angle = 0))
  }
  print(cowplot::plot_grid(plotlist = p, ncol = 3))
  dev.off()

  QCData <- TumorST@meta.data[, c("nCount_Spatial", "nFeature_Spatial", "Mito.percent")]
  openxlsx::write.xlsx(QCData, paste(OutDir, "QC/QCData.xlsx", sep = ""), overwrite = T)

  return(TumorST)
}

```

```{r}
image_dir = InDir <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/Visium_samples/Visium_Data/data/106_A4_60_B3/outs/spatial"
Read10X_Image(
   image_dir,
   image.name = "tissue_lowres_image.png",
   assay = "Spatial",
   slice = "slice1",
   filter.matrix = TRUE
 )
```


```{r}
library(Cottrazm)
library(Seurat)
InDir <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/Visium_samples/Visium_Data/data/106_A4_60_B3/outs/"
Sample <- "106_A4_60_B3"
OutDir <- "/Users/adiallo/Desktop/Thesis/Data_Documents/All_Data/Visium_samples/Visium_Data/data/106_A4_60_B3/"
TumorST <- STPreProcess_mod(InDir = InDir, OutDir = OutDir, Sample = Sample)
```
```{r}
print("STModiCluster")
res = 1.5
TumorST = STModiCluster(InDir = InDir,Sample = Sample, OutDir = OutDir,TumorST = TumorST)
```

